{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/staticmap/+server.ts"],"sourcesContent":["import { env } from '$env/dynamic/private';\nimport { json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\n\nexport const GET: RequestHandler = async ({ url }) => {\n  const origin = url.searchParams.get('origin');\n  const destination = url.searchParams.get('destination');\n  const bbox = url.searchParams.get('bbox');\n  const geojson = url.searchParams.get('geojson');\n\n  console.log('Static map request params:', { origin, destination, bbox, geojson });\n\n  if (!origin || !destination || !bbox || !geojson) {\n    return new Response('Missing required parameters', { status: 400 });\n  }\n\n  if (!env.MAPBOX_TOKEN) {\n    console.error('Mapbox token not found in environment');\n    return new Response('Mapbox token not configured', { status: 500 });\n  }\n\n  try {\n    const [originLng, originLat] = origin.split(',').map(Number);\n    const [destLng, destLat] = destination.split(',').map(Number);\n    const [west, south, east, north] = bbox.split(',').map(Number);\n\n    // Parse and prepare the GeoJSON overlay\n    const parsedGeojson = JSON.parse(geojson);\n    const overlay = {\n      type: 'Feature',\n      properties: {\n        'stroke': '#326334',\n        'stroke-width': 6,\n        'stroke-opacity': 1\n      },\n      geometry: parsedGeojson\n    };\n\n    // Create the static map URL\n    const mapUrl = new URL('https://api.mapbox.com/styles/v1/mapbox/light-v11/static');\n\n    // Add the GeoJSON route first\n    const encodedGeoJson = encodeURIComponent(JSON.stringify(overlay));\n    mapUrl.pathname += `/geojson(${encodedGeoJson})`;\n\n    // Add the origin and destination markers\n    mapUrl.pathname += `,pin-s-warehouse+326334(${originLng},${originLat})`;\n    mapUrl.pathname += `,pin-s-car+326334(${destLng},${destLat})`;\n\n    // Add the viewport\n    mapUrl.pathname += `/[${bbox}]`;\n\n    // Set the size and pixel ratio (increased size for better visibility)\n    mapUrl.pathname += '/800x600@2x';\n\n    // Add the access token\n    mapUrl.searchParams.append('access_token', env.MAPBOX_TOKEN);\n\n    console.log('Requesting Mapbox static map...');\n    const response = await fetch(mapUrl.toString());\n    \n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('Mapbox API error:', {\n        status: response.status,\n        statusText: response.statusText,\n        error: errorText\n      });\n      throw new Error(`Static map request failed: ${response.status} ${response.statusText}`);\n    }\n\n    const imageBuffer = await response.arrayBuffer();\n    \n    return new Response(imageBuffer, {\n      headers: {\n        'Content-Type': 'image/png',\n        'Cache-Control': 'public, max-age=3600'\n      }\n    });\n  } catch (error) {\n    console.error('Static map service error:', error);\n    return new Response(`Static map service error: ${error.message}`, { status: 500 });\n  }\n};\n"],"names":["env"],"mappings":";;AAIO,MAAM,MAAsB,OAAO,EAAE,UAAU;AACpD,QAAM,SAAS,IAAI,aAAa,IAAI,QAAQ;AAC5C,QAAM,cAAc,IAAI,aAAa,IAAI,aAAa;AACtD,QAAM,OAAO,IAAI,aAAa,IAAI,MAAM;AACxC,QAAM,UAAU,IAAI,aAAa,IAAI,SAAS;AAE9C,UAAQ,IAAI,8BAA8B,EAAE,QAAQ,aAAa,MAAM,SAAS;AAEhF,MAAI,CAAC,UAAU,CAAC,eAAe,CAAC,QAAQ,CAAC,SAAS;AAChD,WAAO,IAAI,SAAS,+BAA+B,EAAE,QAAQ,KAAK;AAAA,EAAA;AAGhE,MAAA,CAACA,YAAI,cAAc;AACrB,YAAQ,MAAM,uCAAuC;AACrD,WAAO,IAAI,SAAS,+BAA+B,EAAE,QAAQ,KAAK;AAAA,EAAA;AAGhE,MAAA;AACI,UAAA,CAAC,WAAW,SAAS,IAAI,OAAO,MAAM,GAAG,EAAE,IAAI,MAAM;AACrD,UAAA,CAAC,SAAS,OAAO,IAAI,YAAY,MAAM,GAAG,EAAE,IAAI,MAAM;AACtD,UAAA,CAAC,MAAM,OAAO,MAAM,KAAK,IAAI,KAAK,MAAM,GAAG,EAAE,IAAI,MAAM;AAGvD,UAAA,gBAAgB,KAAK,MAAM,OAAO;AACxC,UAAM,UAAU;AAAA,MACd,MAAM;AAAA,MACN,YAAY;AAAA,QACV,UAAU;AAAA,QACV,gBAAgB;AAAA,QAChB,kBAAkB;AAAA,MACpB;AAAA,MACA,UAAU;AAAA,IACZ;AAGM,UAAA,SAAS,IAAI,IAAI,0DAA0D;AAGjF,UAAM,iBAAiB,mBAAmB,KAAK,UAAU,OAAO,CAAC;AAC1D,WAAA,YAAY,YAAY,cAAc;AAG7C,WAAO,YAAY,2BAA2B,SAAS,IAAI,SAAS;AACpE,WAAO,YAAY,qBAAqB,OAAO,IAAI,OAAO;AAGnD,WAAA,YAAY,KAAK,IAAI;AAG5B,WAAO,YAAY;AAGnB,WAAO,aAAa,OAAO,gBAAgBA,YAAI,YAAY;AAE3D,YAAQ,IAAI,iCAAiC;AAC7C,UAAM,WAAW,MAAM,MAAM,OAAO,UAAU;AAE1C,QAAA,CAAC,SAAS,IAAI;AACV,YAAA,YAAY,MAAM,SAAS,KAAK;AACtC,cAAQ,MAAM,qBAAqB;AAAA,QACjC,QAAQ,SAAS;AAAA,QACjB,YAAY,SAAS;AAAA,QACrB,OAAO;AAAA,MAAA,CACR;AACK,YAAA,IAAI,MAAM,8BAA8B,SAAS,MAAM,IAAI,SAAS,UAAU,EAAE;AAAA,IAAA;AAGlF,UAAA,cAAc,MAAM,SAAS,YAAY;AAExC,WAAA,IAAI,SAAS,aAAa;AAAA,MAC/B,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,iBAAiB;AAAA,MAAA;AAAA,IACnB,CACD;AAAA,WACM,OAAO;AACN,YAAA,MAAM,6BAA6B,KAAK;AACzC,WAAA,IAAI,SAAS,6BAA6B,MAAM,OAAO,IAAI,EAAE,QAAQ,KAAK;AAAA,EAAA;AAErF;"}