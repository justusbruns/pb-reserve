<script>import { getContext, onDestroy } from "svelte";
import { BROWSER as browser } from "esm-env";
import { setContext } from "svelte";
export let id;
export let options = {};
export let onDblClick;
export let onDragEnd;
export let onDragStart;
export let onMouseDown;
export let onMouseMove;
export let onMouseOut;
export let onMouseOver;
export let onMouseUp;
export let onRightClick;
export let onClick;
export let onDrag;
export let onCenterChanged;
export let onLoad;
export let onUnmount;
export let mapContainerStyle = "width:100%;height:100%";
export let mapContainerClassName;
let element = null;
let map = null;
let dblclickListener = null;
let dragendListener = null;
let dragstartListener = null;
let mousedownListener = null;
let mousemoveListener = null;
let mouseoutListener = null;
let mouseoverListener = null;
let mouseupListener = null;
let rightClickListener = null;
let clickListener = null;
let dragListener = null;
let centerChangedListener = null;
$:
  if (map && onDblClick && browser) {
    if (dblclickListener !== null) {
      google.maps.event.removeListener(dblclickListener);
    }
    dblclickListener = google.maps.event.addListener(map, "dblclick", onDblClick);
  }
$:
  if (map && onDragEnd && browser) {
    if (dragendListener !== null) {
      google.maps.event.removeListener(dragendListener);
    }
    dragendListener = google.maps.event.addListener(map, "dragend", onDragEnd);
  }
$:
  if (map && onDragStart && browser) {
    if (dragstartListener !== null) {
      google.maps.event.removeListener(dragstartListener);
    }
    dragstartListener = google.maps.event.addListener(map, "dragstart", onDragStart);
  }
$:
  if (map && onMouseDown && browser) {
    if (mousedownListener !== null) {
      google.maps.event.removeListener(mousedownListener);
    }
    mousedownListener = google.maps.event.addListener(map, "mousedown", onMouseDown);
  }
$:
  if (map && onMouseMove && browser) {
    if (mousemoveListener !== null) {
      google.maps.event.removeListener(mousemoveListener);
    }
    mousemoveListener = google.maps.event.addListener(map, "mousemove", onMouseMove);
  }
$:
  if (map && onMouseOut && browser) {
    if (mouseoutListener !== null) {
      google.maps.event.removeListener(mouseoutListener);
    }
    mouseoutListener = google.maps.event.addListener(map, "mouseout", onMouseOut);
  }
$:
  if (map && onMouseOver && browser) {
    if (mouseoverListener !== null) {
      google.maps.event.removeListener(mouseoverListener);
    }
    mouseoverListener = google.maps.event.addListener(map, "mouseover", onMouseOver);
  }
$:
  if (map && onMouseUp && browser) {
    if (mouseupListener !== null) {
      google.maps.event.removeListener(mouseupListener);
    }
    mouseupListener = google.maps.event.addListener(map, "mouseup", onMouseUp);
  }
$:
  if (map && onRightClick && browser) {
    if (rightClickListener !== null) {
      google.maps.event.removeListener(rightClickListener);
    }
    rightClickListener = google.maps.event.addListener(map, "rightclick", onRightClick);
  }
$:
  if (map && onClick && browser) {
    console.log("ddddd");
    if (clickListener !== null) {
      google.maps.event.removeListener(clickListener);
    }
    clickListener = google.maps.event.addListener(map, "click", onClick);
  }
$:
  if (map && onDrag && browser) {
    if (dragListener !== null) {
      google.maps.event.removeListener(dragListener);
    }
    dragListener = google.maps.event.addListener(map, "drag", onDrag);
  }
$:
  if (map && onCenterChanged && browser) {
    if (centerChangedListener !== null) {
      google.maps.event.removeListener(centerChangedListener);
    }
    centerChangedListener = google.maps.event.addListener(map, "center_changed", onCenterChanged);
  }
const initialize = () => {
  if (!browser)
    return;
  if (!element) {
    throw new Error("map element is not found");
  }
  const google2 = window.google;
  map = new google2.maps.Map(element, options);
  centerChangedListener = onCenterChanged && google2.maps.event.addListener(map, "center_changed", onCenterChanged);
  dblclickListener = onDblClick && google2.maps.event.addListener(map, "dblclick", onDblClick);
  dragendListener = onDragEnd && google2.maps.event.addListener(map, "dragend", onDragEnd);
  dragstartListener = onDragStart && google2.maps.event.addListener(map, "dragstart", onDragStart);
  mousedownListener = onMouseDown && google2.maps.event.addListener(map, "mousedown", onMouseDown);
  mousemoveListener = onMouseMove && google2.maps.event.addListener(map, "mousemove", onMouseMove);
  mouseoutListener = onMouseOut && google2.maps.event.addListener(map, "mouseout", onMouseOut);
  mouseoverListener = onMouseOver && google2.maps.event.addListener(map, "mouseover", onMouseOver);
  mouseupListener = onMouseUp && google2.maps.event.addListener(map, "mouseup", onMouseUp);
  rightClickListener = onRightClick && google2.maps.event.addListener(map, "rightclick", onRightClick);
  clickListener = onClick && google2.maps.event.addListener(map, "click", onClick);
  dragListener = onDrag && google2.maps.event.addListener(map, "drag", onDrag);
  onLoad?.(map);
  setContext("map", { getMap: () => map });
};
onDestroy(() => {
  if (map !== null && browser) {
    if (onUnmount) {
      onUnmount(map);
    }
    const google2 = window.google;
    google2.maps.event.clearInstanceListeners(map);
  }
});
$:
  if (getContext("googleMap")?.isReady && element) {
    initialize();
  }
</script>

<div bind:this={element} {id} style={mapContainerStyle} class={mapContainerClassName}>
	{#if map}
		<slot />
	{/if}
</div>
